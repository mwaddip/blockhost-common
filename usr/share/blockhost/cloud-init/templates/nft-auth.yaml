#cloud-config
# NFT Authentication Cloud-Init Template
# Variables (substituted by vm-generator.py):
#   ${VM_NAME}         - VM hostname
#   ${SIGNING_HOST}    - Host for signing URL ([ipv6] or ipv4)
#   ${USERNAME}        - Linux username
#   ${WALLET_ADDRESS}  - VM owner's wallet address (0x..., bc1q..., addr1...)
#   ${NFT_TOKEN_ID}    - Reserved NFT token ID
#   ${OTP_LENGTH}      - OTP code length
#   ${OTP_TTL}         - OTP time-to-live in seconds
#   ${SECRET_KEY}      - Random 64-char hex string for PAM module
#   ${SIGNING_DOMAIN}  - FQDN for Let's Encrypt (empty = self-signed cert)

hostname: ${VM_NAME}

packages:
  - qemu-guest-agent

users:
  - name: ${USERNAME}
    gecos: "wallet=${WALLET_ADDRESS},nft=${NFT_TOKEN_ID}"
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  - path: /etc/pam_web3/config.toml
    permissions: '0640'
    content: |
      [machine]
      id = "${VM_NAME}"
      secret_key = "${SECRET_KEY}"

      [auth]
      signing_url = "https://${SIGNING_HOST}:8443"
      otp_length = ${OTP_LENGTH}
      otp_ttl_seconds = ${OTP_TTL}
      callback_enabled = true
      callback_grace_seconds = 10

  - path: /etc/web3-auth/config.toml
    permissions: '0640'
    content: |
      [https]
      port = 8443
      bind = ["::", "0.0.0.0"]
      cert_path = "/etc/libpam-web3/tls/cert.pem"
      key_path = "/etc/libpam-web3/tls/key.pem"
      signing_page_path = "/usr/share/libpam-web3/signing-page/index.html"

  - path: /etc/pam.d/sshd
    content: |
      # Web3 NFT authentication for provisioned user only
      auth [success=ok default=ignore] pam_succeed_if.so user = ${USERNAME}
      auth [success=done default=die] pam_web3.so
      auth required pam_deny.so

      # Standard account/session management
      account    required     pam_nologin.so
      @include common-account
      session [success=ok ignore=ignore module_unknown=ignore default=bad] pam_selinux.so close
      session    required     pam_loginuid.so
      session    optional     pam_keyinit.so force revoke
      @include common-session
      session    optional     pam_motd.so  motd=/run/motd.dynamic
      session    optional     pam_motd.so noupdate
      session    optional     pam_mail.so standard noenv
      session    required     pam_limits.so
      session    required     pam_env.so
      session    required     pam_env.so user_readenv=1 envfile=/etc/default/locale
      session [success=ok ignore=ignore module_unknown=ignore default=bad] pam_selinux.so open
      @include common-password

  - path: /etc/ssh/sshd_config.d/web3-only.conf
    content: |
      # Web3 authentication only - disable all other methods
      PubkeyAuthentication no
      PasswordAuthentication no
      KbdInteractiveAuthentication yes
      UsePAM yes
      AuthenticationMethods keyboard-interactive

runcmd:
  - systemctl enable --now qemu-guest-agent
  - systemctl daemon-reload
  - systemctl enable --now web3-auth-svc

  # Upgrade to Let's Encrypt cert if domain available
  - |
    if [ -n "${SIGNING_DOMAIN}" ] && [ -f /etc/letsencrypt/live/${SIGNING_DOMAIN}/fullchain.pem ]; then
      sed -i 's|signing_url = "https://.*:8443"|signing_url = "https://${SIGNING_DOMAIN}:8443"|' /etc/pam_web3/config.toml
      # Point web3-auth-svc at the Let's Encrypt cert
      ln -sf /etc/letsencrypt/live/${SIGNING_DOMAIN}/fullchain.pem /etc/libpam-web3/tls/cert.pem
      ln -sf /etc/letsencrypt/live/${SIGNING_DOMAIN}/privkey.pem /etc/libpam-web3/tls/key.pem
      systemctl restart web3-auth-svc
    fi

  - systemctl restart sshd

final_message: "Web3 NFT authentication configured after $UPTIME seconds"
