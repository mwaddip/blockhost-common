#!/bin/bash
# Post-removal script for blockhost-common

set -e

case "$1" in
    purge)
        # Remove systemd service
        rm -f /etc/systemd/system/blockhost-root-agent.service
        systemctl daemon-reload 2>/dev/null || true

        # Remove configuration directory on purge
        if [ -d /etc/blockhost ]; then
            rm -rf /etc/blockhost
        fi

        # Remove data directory on purge (WARNING: destroys VM database!)
        if [ -d /var/lib/blockhost ]; then
            echo "Warning: Removing /var/lib/blockhost (VM database)"
            rm -rf /var/lib/blockhost
        fi

        # Remove blockhost user if it exists
        if id -u blockhost > /dev/null 2>&1; then
            deluser blockhost 2>/dev/null || true
        fi

        # Remove blockhost group if no users remain
        if getent group blockhost > /dev/null 2>&1; then
            delgroup --only-if-empty blockhost 2>/dev/null || true
        fi
        ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # Keep directories and data on normal remove
        ;;

    *)
        echo "postrm called with unknown argument: $1" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0
